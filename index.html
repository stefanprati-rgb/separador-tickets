<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Separador de Tickets V4 (Com Cores e Bordas)</title>

    <script src="https://cdn.jsdelivr.net/npm/xlsx-js-style@1.2.0/dist/xlsx.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .container {
            background: white;
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            text-align: center;
            width: 450px;
        }

        h2 {
            color: #2c3e50;
            margin-bottom: 5px;
        }

        p {
            color: #7f8c8d;
            font-size: 14px;
            margin-bottom: 30px;
        }

        .btn {
            padding: 12px 20px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
            display: block;
            margin-bottom: 15px;
            box-sizing: border-box;
            border: none;
        }

        .btn-outline {
            border: 2px solid #bdc3c7;
            color: #7f8c8d;
            background-color: transparent;
        }

        .btn-outline:hover {
            border-color: #7f8c8d;
            background-color: #f8f9fa;
            color: #2c3e50;
        }

        .btn-success {
            background-color: #27ae60;
            color: white;
            box-shadow: 0 4px 6px rgba(39, 174, 96, 0.2);
            display: none;
        }

        .btn-success:hover {
            background-color: #219150;
            transform: translateY(-1px);
            box-shadow: 0 6px 8px rgba(39, 174, 96, 0.3);
        }

        .btn-success:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        #fileInput {
            display: none;
        }

        #fileName {
            font-weight: 600;
            color: #2c3e50;
            margin: 10px 0 20px 0;
            min-height: 20px;
            word-break: break-all;
            font-size: 14px;
        }

        #status {
            margin-top: 15px;
            font-size: 13px;
            color: #95a5a6;
            min-height: 20px;
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #27ae60;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
            display: none;
            vertical-align: middle;
            margin-right: 8px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <div class="container">
        <h2>Separador de Tickets V4</h2>
        <p>Separa√ß√£o com Design Profissional (Cores e Bordas)</p>

        <button class="btn btn-outline" onclick="document.getElementById('fileInput').click()">
            üìÇ Escolher Arquivo LDB
        </button>
        <input type="file" id="fileInput" accept=".xlsx, .xls, .xlsm" />

        <div id="fileName"></div>

        <button id="processBtn" class="btn btn-success" onclick="processarArquivo()">
            ‚ö° Processar e Baixar ZIP
        </button>

        <div id="status">Aguardando arquivo...</div>
        <div class="loader" id="loader"></div>
    </div>

    <script>
        let workbookGlobal = null;

        // Defini√ß√£o dos Estilos (Cores e Bordas)
        const estiloHeader = {
            font: { bold: true, color: { rgb: "FFFFFF" }, name: "Calibri", sz: 11 },
            fill: { fgColor: { rgb: "4472C4" } }, // Azul Excel
            alignment: { horizontal: "center", vertical: "center" },
            border: {
                top: { style: "thin", color: { auto: 1 } },
                right: { style: "thin", color: { auto: 1 } },
                bottom: { style: "thin", color: { auto: 1 } },
                left: { style: "thin", color: { auto: 1 } }
            }
        };

        const estiloDados = {
            font: { name: "Calibri", sz: 11 },
            alignment: { vertical: "center" },
            border: {
                top: { style: "thin", color: { rgb: "D9D9D9" } }, // Cinza claro
                right: { style: "thin", color: { rgb: "D9D9D9" } },
                bottom: { style: "thin", color: { rgb: "D9D9D9" } },
                left: { style: "thin", color: { rgb: "D9D9D9" } }
            }
        };

        document.getElementById('fileInput').addEventListener('change', function (e) {
            const file = e.target.files[0];
            if (!file) return;

            const validExtensions = /(\.xlsx|\.xls|\.xlsm)$/i;
            if (!validExtensions.exec(file.name)) {
                alert('Arquivo inv√°lido! Selecione Excel (.xlsx, .xls, .xlsm).');
                this.value = '';
                document.getElementById('fileName').innerText = "";
                document.getElementById('processBtn').style.display = 'none';
                return;
            }

            document.getElementById('fileName').innerText = file.name;
            document.getElementById('status').innerText = "Lendo estrutura...";
            document.getElementById('loader').style.display = 'inline-block';

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    workbookGlobal = XLSX.read(data, { type: 'array' });

                    document.getElementById('loader').style.display = 'none';
                    document.getElementById('status').innerText = "Arquivo carregado. Pronto para gerar.";
                    document.getElementById('processBtn').style.display = 'block';
                } catch (err) {
                    alert("Erro ao ler o arquivo. Pode estar corrompido.");
                    document.getElementById('status').innerText = "Erro na leitura.";
                    document.getElementById('loader').style.display = 'none';
                }
            };
            reader.readAsArrayBuffer(file);
        });

        async function processarArquivo() {
            if (!workbookGlobal) return;

            const btn = document.getElementById('processBtn');
            const originalText = btn.innerText;
            btn.disabled = true;
            btn.innerText = "Gerando Planilhas...";
            document.getElementById('loader').style.display = 'inline-block';

            try {
                const firstSheetName = workbookGlobal.SheetNames[0];
                const worksheet = workbookGlobal.Sheets[firstSheetName];
                const rawData = XLSX.utils.sheet_to_json(worksheet, { header: 1, defval: "" });

                const HEADER_ROW_INDEX = 2;
                if (rawData.length <= HEADER_ROW_INDEX) throw new Error("Planilha vazia ou inv√°lida.");

                const headerRow = rawData[HEADER_ROW_INDEX];

                const mapCols = {
                    "Key": -1, "Brand": -1, "Catalog ID": -1,
                    "Reporter": -1, "Created": -1, "Status": -1
                };

                headerRow.forEach((val, idx) => {
                    const cleanVal = normalizarTexto(String(val));
                    if (cleanVal === "key") mapCols["Key"] = idx;
                    if (cleanVal === "brand") mapCols["Brand"] = idx;
                    if (cleanVal === "catalogid") mapCols["Catalog ID"] = idx;
                    if (cleanVal === "reporter") mapCols["Reporter"] = idx;
                    if (cleanVal === "created") mapCols["Created"] = idx;
                    if (cleanVal === "status") mapCols["Status"] = idx;
                });

                if (mapCols["Brand"] === -1) throw new Error("Coluna 'Brand' n√£o encontrada na linha 3.");

                const ticketsPorMarca = {};

                for (let i = HEADER_ROW_INDEX + 1; i < rawData.length; i++) {
                    const row = rawData[i];
                    const rawBrand = row[mapCols["Brand"]];
                    if (!rawBrand) continue;

                    const brandKey = normalizarTexto(String(rawBrand));
                    const brandName = String(rawBrand).trim();

                    if (!ticketsPorMarca[brandKey]) {
                        ticketsPorMarca[brandKey] = { name: brandName, rows: [] };
                        // Header
                        ticketsPorMarca[brandKey].rows.push([
                            "Tickets", "Marca", "EAN", "Responsavel", "Data Criacao", "Status", "Prioridade", "KPI Foco"
                        ]);
                    }

                    ticketsPorMarca[brandKey].rows.push([
                        row[mapCols["Key"]],
                        row[mapCols["Brand"]],
                        row[mapCols["Catalog ID"]],
                        row[mapCols["Reporter"]],
                        converterData(row[mapCols["Created"]]),
                        row[mapCols["Status"]],
                        "", ""
                    ]);
                }

                const zip = new JSZip();

                for (const key in ticketsPorMarca) {
                    const item = ticketsPorMarca[key];
                    const cleanName = item.name.replace(/[\/\\?%*:|"<>]/g, '_');

                    // Cria Sheet
                    const newWs = XLSX.utils.aoa_to_sheet(item.rows);

                    // === APLICA√á√ÉO DE ESTILOS ===
                    const range = XLSX.utils.decode_range(newWs['!ref']);

                    for (let R = range.s.r; R <= range.e.r; ++R) {
                        for (let C = range.s.c; C <= range.e.c; ++C) {
                            const cell_address = XLSX.utils.encode_cell({ r: R, c: C });
                            if (!newWs[cell_address]) continue;

                            // Linha 0 = Cabe√ßalho, Resto = Dados
                            if (R === 0) {
                                newWs[cell_address].s = estiloHeader;
                            } else {
                                newWs[cell_address].s = estiloDados;
                            }
                        }
                    }

                    // Larguras
                    newWs['!cols'] = [
                        { wch: 15 }, { wch: 20 }, { wch: 15 }, { wch: 25 },
                        { wch: 15 }, { wch: 15 }, { wch: 12 }, { wch: 12 }
                    ];

                    const newWb = XLSX.utils.book_new();
                    XLSX.utils.book_append_sheet(newWb, newWs, "Base Tickets");

                    const excelBuffer = XLSX.write(newWb, { bookType: 'xlsx', type: 'array' });
                    zip.file(`Base_Tickets_${cleanName}.xlsx`, excelBuffer);
                }

                const content = await zip.generateAsync({ type: "blob" });
                saveAs(content, "Tickets_Formatados_V4.zip");

                document.getElementById('status').innerText = "Sucesso! Download iniciado.";

            } catch (err) {
                alert("Erro: " + err.message);
                document.getElementById('status').innerText = "Erro no processamento.";
            } finally {
                btn.disabled = false;
                btn.innerText = originalText;
                document.getElementById('loader').style.display = 'none';
            }
        }

        function normalizarTexto(str) {
            if (!str) return "";
            return str.toString().replace(/\u00A0/g, " ").replace(/\t/g, " ").replace(/ /g, "").toLowerCase();
        }

        function converterData(val) {
            if (!val) return "";
            if (typeof val === 'number') {
                const date = new Date(Math.round((val - 25569) * 86400 * 1000));
                return formatDateBr(date);
            }
            let txt = String(val).toLowerCase().replace(/[\/\-\,\.]/g, " ").replace(/\s+/g, " ").trim();
            const parts = txt.split(" ");
            if (parts.length >= 3) {
                const d = parseInt(parts[0]);
                const mStr = parts[1].substring(0, 3);
                let y = parseInt(parts[2]);
                const meses = { "jan": 0, "feb": 1, "mar": 2, "apr": 3, "may": 4, "jun": 5, "jul": 6, "aug": 7, "sep": 8, "oct": 9, "nov": 10, "dec": 11, "out": 9, "ago": 7, "fev": 1, "abr": 3, "mai": 4, "dez": 11, "set": 8 };
                if (!isNaN(d) && !isNaN(y) && meses.hasOwnProperty(mStr)) {
                    if (y < 100) y += 2000;
                    return formatDateBr(new Date(y, meses[mStr], d));
                }
            }
            return val;
        }

        function formatDateBr(date) {
            if (isNaN(date.getTime())) return "";
            return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
        }
    </script>

</body>

</html>